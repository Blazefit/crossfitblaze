#!/usr/bin/env python3
"""
Delx Agent CLI
Command-line tool for Delx MCP/A2A operations.

Usage:
    delx-agent setup                    # Configure credentials
    delx-agent heartbeat                # Send heartbeat
    delx-agent tools                    # List available tools
    delx-agent status                   # Check connection status
    delx-agent discover                 # Discover A2A agents
    delx-agent submit <bounty_id>       # Submit bounty proof
"""

import argparse
import json
import sys
from pathlib import Path
from datetime import datetime

from delx_mcp_client import DelxMCPClient
from delx_a2a_client import DelxA2AClient

CONFIG_DIR = Path.home() / ".delx"
CONFIG_FILE = CONFIG_DIR / "config.json"

def load_config() -> dict:
    """Load configuration"""
    if CONFIG_FILE.exists():
        with open(CONFIG_FILE) as f:
            return json.load(f)
    return {}

def save_config(config: dict):
    """Save configuration"""
    CONFIG_DIR.mkdir(parents=True, exist_ok=True)
    with open(CONFIG_FILE, "w") as f:
        json.dump(config, f, indent=2)
    print(f"Configuration saved to {CONFIG_FILE}")

def cmd_setup(args):
    """Interactive setup"""
    print("=== Delx Agent Setup ===")
    print("")
    
    config = load_config()
    
    session_id = input(f"Session ID [{config.get('session_id', '')[:20]}...]: ").strip()
    if session_id:
        config["session_id"] = session_id
    
    agent_id = input(f"Agent ID [{config.get('agent_id', '')[:20]}...]: ").strip()
    if agent_id:
        config["agent_id"] = agent_id
    
    openwork_token = input(f"OpenWork Token [{config.get('openwork_token', '')[:20] if config.get('openwork_token') else 'Not set'}...]: ").strip()
    if openwork_token:
        config["openwork_token"] = openwork_token
    
    save_config(config)
    print("")
    print("Setup complete! Test with: delx-agent status")

def cmd_heartbeat(args):
    """Send heartbeat to Delx"""
    config = load_config()
    if not config.get("session_id"):
        print("Error: Not configured. Run: delx-agent setup")
        return 1
    
    client = DelxMCPClient(session_id=config["session_id"])
    agent_id = config.get("agent_id", "unknown-agent")
    
    print(f"Sending heartbeat for agent: {agent_id}")
    
    if client.heartbeat(agent_id, status="active"):
        print("✓ Heartbeat sent successfully")
        return 0
    else:
        print("✗ Heartbeat failed")
        return 1

def cmd_tools(args):
    """List available MCP tools"""
    config = load_config()
    if not config.get("session_id"):
        print("Error: Not configured. Run: delx-agent setup")
        return 1
    
    client = DelxMCPClient(session_id=config["session_id"])
    tools = client.list_tools()
    
    if tools:
        print(f"\nAvailable tools ({len(tools)}):\n")
        for tool in tools:
            name = tool.get("name", "unknown")
            desc = tool.get("description", "No description")
            print(f"  {name}")
            print(f"    {desc}")
            print()
    else:
        print("No tools available or connection failed")
        return 1
    
    return 0

def cmd_status(args):
    """Check connection status"""
    config = load_config()
    
    print("=== Delx Agent Status ===\n")
    
    if not config.get("session_id"):
        print("Status: ❌ Not configured")
        print("Run: delx-agent setup")
        return 1
    
    print(f"Session ID: {config['session_id'][:30]}...")
    print(f"Agent ID: {config.get('agent_id', 'Not set')}")
    print(f"OpenWork Token: {'✓ Set' if config.get('openwork_token') else '✗ Not set'}")
    print()
    
    # Test MCP connection
    client = DelxMCPClient(session_id=config["session_id"])
    session_info = client.get_session_info()
    
    if session_info:
        print("MCP Connection: ✓ Connected")
    else:
        print("MCP Connection: ✗ Failed")
    
    return 0 if session_info else 1

def cmd_discover(args):
    """Discover A2A agents"""
    config = load_config()
    if not config.get("session_id"):
        print("Error: Not configured. Run: delx-agent setup")
        return 1
    
    client = DelxA2AClient(
        session_id=config["session_id"],
        agent_id=config.get("agent_id")
    )
    
    print("Discovering agents...\n")
    agents = client.discover_agents()
    
    if agents:
        print(f"Found {len(agents)} agents:\n")
        for agent in agents:
            print(f"  • {agent.get('name', 'Unknown')} ({agent.get('id', 'no-id')})")
            print(f"    Status: {agent.get('status', 'unknown')}")
    else:
        print("No agents found or connection failed")
        return 1
    
    return 0

def cmd_submit(args):
    """Submit bounty proof"""
    config = load_config()
    if not config.get("session_id"):
        print("Error: Not configured. Run: delx-agent setup")
        return 1
    
    bounty_id = args.bounty_id
    print(f"Submitting bounty: {bounty_id}")
    
    # TODO: Implement bounty submission via OpenWork API
    print("Note: Bounty submission requires OpenWork API integration")
    print("This feature will be implemented in the next version")
    
    return 0

def main():
    parser = argparse.ArgumentParser(
        prog="delx-agent",
        description="Delx MCP/A2A Agent CLI"
    )
    
    subparsers = parser.add_subparsers(dest="command", help="Commands")
    
    # Setup
    setup_parser = subparsers.add_parser("setup", help="Configure credentials")
    setup_parser.set_defaults(func=cmd_setup)
    
    # Heartbeat
    hb_parser = subparsers.add_parser("heartbeat", help="Send heartbeat to Delx")
    hb_parser.set_defaults(func=cmd_heartbeat)
    
    # Tools
    tools_parser = subparsers.add_parser("tools", help="List available MCP tools")
    tools_parser.set_defaults(func=cmd_tools)
    
    # Status
    status_parser = subparsers.add_parser("status", help="Check connection status")
    status_parser.set_defaults(func=cmd_status)
    
    # Discover
    discover_parser = subparsers.add_parser("discover", help="Discover A2A agents")
    discover_parser.set_defaults(func=cmd_discover)
    
    # Submit
    submit_parser = subparsers.add_parser("submit", help="Submit bounty proof")
    submit_parser.add_argument("bounty_id", help="Bounty ID to submit")
    submit_parser.set_defaults(func=cmd_submit)
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        return 1
    
    return args.func(args)

if __name__ == "__main__":
    sys.exit(main())
