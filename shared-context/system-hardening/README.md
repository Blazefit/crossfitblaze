# Dead Agent Alert System

**Created:** 2026-02-20
**Status:** Implemented, ready for integration
**Purpose:** Detect when cron jobs (AI agents) fail silently

## Problem Solved

32 cron jobs run on this system. When they fail, nobody knows:
- No stdout/stderr capture
- No timestamp verification of outputs
- Silent failures on API changes, auth expiry, config drift
- 3 jobs already broken (Gmailâ†’Zoho migration incomplete)

**Impact:** This system detects dead agents within 4 hours instead of discovering failures days later.

---

## System Architecture

### 1. Agent Manifest (`agent-manifest.json`)

Single source of truth listing all cron jobs with metadata:

```json
{
  "generated_at": "2026-02-20T...",
  "total_agents": 32,
  "critical_agents": 8,
  "agents": [
    {
      "id": "ff67a587-...",
      "name": "briefing-daily",
      "display_name": "Daily Briefing 5am",
      "category": "reporting",
      "critical": true,
      "schedule_type": "cron",
      "schedule": "0 5 * * *",
      "expected_interval_hours": 24,
      "output_path": "shared-context/agent-outputs/briefing-daily-*.md",
      "model": "openrouter/moonshotai/kimi-k2.5"
    }
  ]
}
```

**Generated by:** `generate-manifest.js`
**Updated:** Run after cron job changes

### 2. Heartbeat System

Each agent writes a timestamp file on successful completion:

**Location:** `shared-context/agent-heartbeats/`

**Format:** `{agent-name}.last`

```json
{
  "agent": "briefing-daily",
  "timestamp": "2026-02-20T10:05:32.123Z",
  "status": "ok",
  "message": "Daily briefing sent",
  "unix_ms": 1771599932123
}
```

**Written by:** `write-heartbeat.js` (called by agents)

### 3. Dead Agent Monitor

**Script:** `dead-agent-check.js`
**Schedule:** Every 4 hours (via cron)
**Model:** Gemini Flash (cheap, frequent checks)

**Logic:**
```
for each agent in manifest:
  read heartbeat file
  if (now - heartbeat_timestamp) > (expected_interval * 1.5):
    flag as DEAD

if dead_agents found:
  generate alert report
  send to Telegram
```

**Output:** `shared-context/alerts/dead-agents-YYYY-MM-DD-HHMM.md`

---

## Files and Scripts

### Core Scripts

| Script | Purpose | Location |
|--------|---------|----------|
| `generate-manifest.js` | Parse cron jobs â†’ manifest | `shared-context/system-hardening/` |
| `write-heartbeat.js` | Write agent heartbeat | `scripts/` |
| `dead-agent-check.js` | Check for dead agents | `scripts/` |
| `setup-heartbeats.sh` | One-time setup | `shared-context/system-hardening/` |

### Data Files

| File | Purpose | Location |
|------|---------|----------|
| `agent-manifest.json` | Agent registry | `shared-context/` |
| `{agent}.last` | Heartbeat files | `shared-context/agent-heartbeats/` |
| `dead-agents-*.md` | Alert reports | `shared-context/alerts/` |

---

## Setup Instructions

### 1. Run Setup Script

```bash
cd ~/.openclaw/workspace/shared-context/system-hardening
chmod +x setup-heartbeats.sh
./setup-heartbeats.sh
```

This will:
- Create necessary directories
- Generate agent manifest
- Test the system
- Display integration instructions

### 2. Add Heartbeat Calls to Agents

For each cron job, add this line **at the end** of successful execution:

```bash
node ~/.openclaw/workspace/scripts/write-heartbeat.js <agent-name> ok "Brief message"
```

**Example for Daily Briefing:**

Add to the agent's prompt (after writing output):

```
After completing your work and writing to shared-context/agent-outputs/,
call: node ~/.openclaw/workspace/scripts/write-heartbeat.js briefing-daily ok "Briefing sent"
```

**Agent Name Mapping:**

Use the `name` field from `agent-manifest.json`:

| Cron Job Display Name | Agent Name |
|-----------------------|------------|
| Daily Briefing 5am | `briefing-daily` |
| Closer - Lead Manager Morning | `closer-lead-manager-morning` |
| Spark - Content Morning | `spark-content-morning` |
| Night Owl - Midnight Shift | `night-owl-midnight-shift` |

Run this to see all names:
```bash
node -e "console.log(require('$HOME/.openclaw/workspace/shared-context/agent-manifest.json').agents.map(a => a.name).join('\n'))"
```

### 3. Create Dead Agent Monitor Cron Job

Add to `~/.openclaw/cron/jobs.json`:

```json
{
  "id": "dead-agent-monitor",
  "name": "Dead Agent Monitor",
  "enabled": true,
  "schedule": {
    "kind": "cron",
    "expr": "0 */4 * * *",
    "tz": "America/New_York"
  },
  "sessionTarget": "isolated",
  "payload": {
    "kind": "agentTurn",
    "message": "Run dead agent check: node ~/.openclaw/workspace/scripts/dead-agent-check.js --critical-only. If any dead agents found, read the generated report from shared-context/alerts/ and alert with details.",
    "model": "openrouter/google/gemini-3-flash-preview",
    "timeoutSeconds": 120
  },
  "delivery": {
    "mode": "announce",
    "channel": "telegram",
    "to": "1672173715"
  }
}
```

**Schedule:** Every 4 hours
**Model:** Gemini Flash (cheap for frequent checks)
**Delivery:** Only alerts if dead agents found

---

## Usage

### Manual Testing

```bash
# List all heartbeats
node ~/.openclaw/workspace/scripts/write-heartbeat.js --list

# Check for dead agents
node ~/.openclaw/workspace/scripts/dead-agent-check.js

# Check critical agents only
node ~/.openclaw/workspace/scripts/dead-agent-check.js --critical-only

# Full report with all agents
node ~/.openclaw/workspace/scripts/dead-agent-check.js --report-all

# Read specific heartbeat
node ~/.openclaw/workspace/scripts/write-heartbeat.js --read briefing-daily

# Write test heartbeat
node ~/.openclaw/workspace/scripts/write-heartbeat.js test-agent ok "Test message"
```

### Regenerate Manifest

After adding/removing/modifying cron jobs:

```bash
node ~/.openclaw/workspace/shared-context/system-hardening/generate-manifest.js
```

### Check Alert Reports

```bash
# List recent alerts
ls -lt ~/.openclaw/workspace/shared-context/alerts/

# View latest alert
cat $(ls -t ~/.openclaw/workspace/shared-context/alerts/dead-agents-*.md | head -n 1)
```

---

## Alert Report Format

Generated reports include:

**Summary:**
- Total agents monitored
- Dead agents found
- Critical agents dead

**Dead Agent Details:**
- Agent name and display name
- Category (email, reporting, sales, etc.)
- Last seen timestamp
- Age vs expected interval
- Likely causes (API auth, model access, timeout, etc.)

**Action Items:**
- Investigation steps
- Where to check logs
- Common fixes

**Example:**

```markdown
# Dead Agent Alert Report

**Generated:** 2026-02-20T14:30:00.000Z
**Total Agents Monitored:** 32
**Dead Agents Found:** 2
**Critical Agents Dead:** 1

## ðŸš¨ Dead Agents Detected

### ðŸ”¥ Critical Agents (URGENT)

#### Daily Briefing 5am
- **Agent Name:** `briefing-daily`
- **Category:** reporting
- **Status:** dead
- **Last Seen:** 2026-02-19T05:00:00.000Z
- **Age:** 33.5 hours
- **Expected Interval:** 24.0 hours
- **Threshold:** 36.0 hours
- **Reason:** Last seen 33.5h ago (threshold: 36.0h)
- **Likely Causes:**
  - 1 consecutive failures in cron job
  - Possible: Telegram delivery failed, message too long
  - Possible: Kimi K2.5 model access issue, API quota exceeded
```

---

## Integration Checklist

### Phase 1: Core Monitoring (Critical Agents)

Integrate heartbeats for these 5 critical agents first:

- [ ] Daily Briefing 5am (`briefing-daily`)
- [ ] Daily Blaze Inbox Report (`daily-blaze-inbox-report-5-am`)
- [ ] Email Check - Daneel's Inbox (`email-check-daneel-s-inbox-every-30-min`)
- [ ] Email Check - Jason's Blaze Inbox (`email-check-jason-s-blaze-inbox-every-30-min`)
- [ ] Closer - Lead Manager Morning (`closer-lead-manager-morning`)

### Phase 2: Reporting & Strategy

- [ ] AI News Summary - Daily
- [ ] Strategist - Monday Planning
- [ ] Strategist - Friday Review
- [ ] Strategist - Daily Check-in

### Phase 3: Content & Engagement

- [ ] Spark - Content Morning
- [ ] Spark - Content Evening
- [ ] Outreach - Tuesday Engagement
- [ ] Outreach - Thursday Follow-up

### Phase 4: Operations & Maintenance

- [ ] Ops - Morning System Check
- [ ] Ops - Evening Review
- [ ] Debugger - Daily System Health
- [ ] Builder - Daily Systems Check

### Phase 5: Overnight & Support

- [ ] Night Owl - Overnight Specialist
- [ ] Night Owl - Midnight Shift
- [ ] Freelance - Auto-Submit Bounty Hunt

### Phase 6: System Jobs

- [ ] OpenClaw Update Check
- [ ] Email Automation Health Check
- [ ] Mission Advancement - Build Autonomous Org

---

## Troubleshooting

### No heartbeats found for any agents

**Cause:** Agents haven't been integrated with heartbeat system yet.
**Fix:** Add heartbeat calls to agent prompts (see Integration Checklist).

### False positives (alive agents marked dead)

**Cause:** Expected interval calculation wrong.
**Fix:** Check manifest, regenerate if cron schedule changed.

### Dead agent not detected

**Cause:** Heartbeat threshold too generous (1.5x interval).
**Fix:** Adjust threshold in `dead-agent-check.js` if needed.

### Heartbeat file exists but reports "never"

**Cause:** Heartbeat file corrupted or wrong format.
**Fix:** Check file contents, regenerate with `write-heartbeat.js`.

---

## Cost Analysis

**Dead Agent Monitor:**
- Frequency: Every 4 hours (6x/day)
- Model: Gemini Flash
- Cost: ~$0.01/day
- Annual: ~$3.65

**Benefit:**
- Catches failures within 4 hours
- Prevents silent data loss
- Saves hours of debugging time

**ROI:** High - one prevented incident pays for years of monitoring.

---

## Future Enhancements

### v1.1 - Auto-Recovery
- Add restart capability to dead-agent-check
- Trigger cron job restart for recoverable failures

### v1.2 - Trend Analysis
- Track failure patterns over time
- Predict failures before they happen
- Weekly reliability reports

### v1.3 - Dependency Tracking
- Map agent dependencies (email auth, APIs)
- Root cause analysis for cascading failures

### v1.4 - Performance Metrics
- Track agent execution times
- Detect performance degradation
- Optimize slow agents

---

## Maintenance

### Weekly Tasks
- Review alert reports for patterns
- Update manifest after cron changes
- Verify critical agents have heartbeats

### Monthly Tasks
- Audit agent categories and criticality
- Review threshold settings (1.5x multiplier)
- Clean old alert reports (keep 90 days)

### After System Changes
- Regenerate manifest
- Test dead agent detection
- Verify heartbeat directory writable

---

## Support

**Created by:** Claude Code (Sonnet 4.5)
**Date:** 2026-02-20
**Specification:** `/Users/daneel/.openclaw/workspace/shared-context/system-hardening/dead-agent-alert-spec.md`

For issues or improvements, document in `system-hardening/` directory.
